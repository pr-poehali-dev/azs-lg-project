# API выполнения операции заправки

## URL функции
```
https://functions.poehali.dev/0dea58ba-9689-4be9-a8a2-41cb13d92611
```

## Метод
`POST`

## Формат запроса
Content-Type: `application/json`

## Параметры запроса (JSON body)
- `card_code` (обязательный, string) - номер топливной карты
- `quantity` (обязательный, number) - количество топлива в литрах (должно быть > 0)
- `price` (обязательный, number) - цена за литр в рублях
- `code_1c` (обязательный, string) - код АЗС в 1С (например, "200001")
- `comment` (необязательный, string) - комментарий к операции

## Пример запроса из 1С

### HTTP-запрос
```
POST https://functions.poehali.dev/0dea58ba-9689-4be9-a8a2-41cb13d92611
Content-Type: application/json

{
  "card_code": "0001",
  "quantity": 45.5,
  "price": 52.5,
  "code_1c": "200001",
  "comment": "Заправка автомобиля А123БВ"
}
```

### Код 1С (HTTPСоединение)
```bsl
Соединение = Новый HTTPСоединение("functions.poehali.dev", 443, , , , 30, Новый ЗащищенноеСоединениеOpenSSL);

ДанныеЗаправки = Новый Структура;
ДанныеЗаправки.Вставить("card_code", "0001");
ДанныеЗаправки.Вставить("quantity", 45.5);
ДанныеЗаправки.Вставить("price", 52.5);
ДанныеЗаправки.Вставить("code_1c", "200001");
ДанныеЗаправки.Вставить("comment", "Заправка автомобиля А123БВ");

ЗаписьJSON = Новый ЗаписьJSON;
ЗаписьJSON.УстановитьСтроку();
ЗаписатьJSON(ЗаписьJSON, ДанныеЗаправки);
JSONСтрока = ЗаписьJSON.Закрыть();

Запрос = Новый HTTPЗапрос("/0dea58ba-9689-4be9-a8a2-41cb13d92611");
Запрос.Заголовки.Вставить("Content-Type", "application/json");
Запрос.УстановитьТелоИзСтроки(JSONСтрока);

Ответ = Соединение.ОтправитьДляОбработки(Запрос);

Если Ответ.КодСостояния = 200 Тогда
    ЧтениеJSON = Новый ЧтениеJSON;
    ЧтениеJSON.УстановитьСтроку(Ответ.ПолучитьТелоКакСтроку());
    Результат = ПрочитатьJSON(ЧтениеJSON);
    ЧтениеJSON.Закрыть();
    
    Если Результат["success"] = Истина Тогда
        НовыйБаланс = Результат["new_balance"];
        СуммаОперации = Результат["amount"];
        Сообщить("Заправка выполнена. Новый баланс: " + НовыйБаланс + " л. Сумма: " + СуммаОперации + " руб.");
    КонецЕсли;
КонецЕсли;
```

## Формат ответа

### Успешная операция (200 OK)
```json
{
  "success": true,
  "card_code": "0001",
  "operation_type": "заправка",
  "quantity": 45.5,
  "price": 52.5,
  "amount": 2388.75,
  "previous_balance": 1000.0,
  "new_balance": 954.5,
  "code_1c": "200001",
  "station_name": "АЗС СОЮЗ №3",
  "operation_date": "2025-12-14 19:32:20"
}
```

### Ошибка - недостаточно топлива на карте (400 Bad Request)
```json
{
  "error": "Недостаточно топлива на карте",
  "current_balance": 10.0,
  "requested_quantity": 50.0
}
```

### Ошибка - карта не найдена (404 Not Found)
```json
{
  "error": "Карта 9999 не найдена"
}
```

### Ошибка - некорректные данные (400 Bad Request)
```json
{
  "error": "Не указан номер карты (card_code)"
}
```

```json
{
  "error": "Количество топлива должно быть больше 0"
}
```

```json
{
  "error": "Не указан код АЗС (code_1c)"
}
```

```json
{
  "error": "АЗС с кодом 999999 не найдена"
}
```

## Поля ответа (при успехе)

| Поле | Тип | Описание |
|------|-----|----------|
| success | boolean | Успешность операции (всегда true) |
| card_code | string | Номер топливной карты |
| operation_type | string | Тип операции (всегда "заправка") |
| quantity | number | Количество заправленного топлива (литры) |
| price | number | Цена за литр (рубли) |
| amount | number | Сумма операции (quantity × price) |
| previous_balance | number | Баланс до операции (литры) |
| new_balance | number | Баланс после операции (литры) |
| code_1c | string | Код АЗС в 1С |
| station_name | string | Название АЗС |
| operation_date | string | Дата и время операции (YYYY-MM-DD HH:MM:SS) |

## Что происходит при вызове API

1. Проверяется существование карты по номеру `card_code`
2. Проверяется достаточность баланса на карте
3. Находится АЗС в базе данных по коду `code_1c`
4. Уменьшается баланс карты на `quantity` литров
5. Создается запись в истории операций с типом "заправка"
6. Возвращается результат операции с новым балансом

## Примеры использования

### cURL
```bash
curl -X POST "https://functions.poehali.dev/0dea58ba-9689-4be9-a8a2-41cb13d92611" \
  -H "Content-Type: application/json" \
  -d '{
    "card_code": "0001",
    "quantity": 45.5,
    "price": 52.5,
    "code_1c": "200001",
    "comment": "Заправка автомобиля"
  }'
```

### PowerShell
```powershell
$body = @{
    card_code = "0001"
    quantity = 45.5
    price = 52.5
    code_1c = "200001"
    comment = "Заправка автомобиля"
} | ConvertTo-Json

$response = Invoke-RestMethod -Uri "https://functions.poehali.dev/0dea58ba-9689-4be9-a8a2-41cb13d92611" `
    -Method Post `
    -ContentType "application/json" `
    -Body $body

$response
```

### Python
```python
import requests

data = {
    "card_code": "0001",
    "quantity": 45.5,
    "price": 52.5,
    "code_1c": "200001",
    "comment": "Заправка автомобиля"
}

response = requests.post(
    'https://functions.poehali.dev/0dea58ba-9689-4be9-a8a2-41cb13d92611',
    json=data
)

result = response.json()
if result.get('success'):
    print(f"Заправка выполнена! Новый баланс: {result['new_balance']} л")
    print(f"Сумма операции: {result['amount']} руб")
```

## Важные особенности

1. **Транзакционность**: Операция выполняется атомарно - либо и баланс обновляется, и запись создается, либо ничего не происходит при ошибке
2. **Проверка баланса**: Система не позволит заправить больше топлива, чем есть на карте
3. **Автоматический расчет**: Сумма операции рассчитывается автоматически (quantity × price)
4. **История операций**: Каждая заправка сохраняется в истории с точной датой и временем